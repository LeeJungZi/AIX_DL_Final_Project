<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ìŠ¤ë§ˆíŠ¸ ë¯¹ì„œ</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; padding: 20px; background-color: #121212; color: #e0e0e0; }
        .container { background: #1e1e1e; padding: 30px; border-radius: 15px; max-width: 800px; margin: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h1 { color: #00d2ff; }
        
        .upload-section { border: 2px dashed #444; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .btn { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; transition: 0.2s; }
        .btn:hover:not(:disabled) { background: #0056b3; }
        .btn:disabled { background: #444; cursor: not-allowed; }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #00d2ff; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; margin-right: 10px;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* íŠ¸ë™ ë ˆì´ì•„ì›ƒ */
        .track-row { 
            background: #2c2c2c; margin: 15px 0; padding: 15px; border-radius: 10px; 
            display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between;
            border-left: 5px solid #555;
        }
        .track-info { flex: 1; text-align: left; min-width: 150px; }
        .track-name { font-size: 18px; font-weight: bold; display: block; margin-bottom: 5px; text-transform: uppercase;}
        .eq-controls { flex: 2; display: flex; gap: 15px; justify-content: center; min-width: 300px; }
        
        /* ìŠ¬ë¼ì´ë” ìŠ¤íƒ€ì¼ */
        .slider-group { text-align: center; }
        .slider-group label { display: block; font-size: 12px; color: #888; margin-bottom: 2px; }
        input[type=range] { width: 80px; accent-color: #00d2ff; cursor: pointer; }
        .val-display { font-size: 12px; font-weight: bold; color: #00d2ff; }

        audio { width: 100%; margin-top: 10px; height: 30px; }
        
        .master-controls { margin-top: 20px; padding-top: 20px; border-top: 1px solid #444; }
        .btn-green { background: #28a745; }
        .btn-red { background: #dc3545; }

        /* íŠ¸ë™ë³„ ìƒ‰ìƒ */
        .t-vocals { border-color: #ff6b6b; color: #ff6b6b; }
        .t-drums { border-color: #4ecdc4; color: #4ecdc4; }
        .t-bass { border-color: #ffe66d; color: #ffe66d; }
        .t-other { border-color: #1a535c; color: #1a535c; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ›ï¸ AI ìŠ¤ë§ˆíŠ¸ ë¯¹ì„œ</h1>
        <p>AIê°€ ì œì•ˆí•œ EQë¥¼ í™•ì¸í•˜ê³ , ìŠ¬ë¼ì´ë”ë¡œ ì§ì ‘ í†¤ì„ ì¡ì•„ë³´ì„¸ìš”.</p>

        <!-- ë©”ì‹œì§€ ë° ë¡œë”© ìƒíƒœ -->
        <div id="status" style="margin-top: 10px; color: #ffcc00; font-weight: bold;"></div>

        <form id="upload-form" class="upload-section">
            <input type="file" id="audioFile" name="file" accept=".mp3, .wav, .ogg" required>
            
            <div style="margin-top: 15px; text-align: left;">
                <input type="checkbox" id="use-ai-eq" name="use_ai_eq" checked>
                <label for="use-ai-eq" style="color: #bbb;">AI EQ ì˜ˆì¸¡ ì‚¬ìš© (MasteringAI)</label>
            </div>
            
            <button type="submit" id="uploadBtn" class="btn" style="margin-top: 15px;">ì—…ë¡œë“œ ë° ë¶„ì„</button>
        </form>

        <div id="mixer-area" style="display: none;">
            <div class="master-controls">
                <button class="btn btn-green" onclick="playAll()">â–¶ ì „ì²´ ì¬ìƒ</button>
                <button class="btn btn-red" onclick="stopAll()">â¹ ì „ì²´ ì •ì§€</button>
            </div>
            <div id="tracks-container"></div>
        </div>
    </div>

    <script>
        const API_URL = '/upload';
        
        const uploadForm = document.getElementById('upload-form');
        const audioFile = document.getElementById('audioFile');
        const uploadBtn = document.getElementById('uploadBtn');
        const statusDisplay = document.getElementById('status');
        const mixerArea = document.getElementById('mixer-area');
        const tracksContainer = document.getElementById('tracks-container');

        // Web Audio API ì»¨í…ìŠ¤íŠ¸ (ë¸Œë¼ìš°ì €ì˜ ì˜¤ë””ì˜¤ ì—”ì§„)
        let audioCtx;
        const tracks = {}; // íŠ¸ë™ë³„ ë…¸ë“œ ì €ì¥ì†Œ { vocals: { low, mid, high } }

        // ====== 1. API í†µì‹  ë° ìƒíƒœ ê´€ë¦¬ ======

        uploadForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const file = audioFile.files[0];
            
            uploadBtn.disabled = true;
            statusDisplay.innerHTML = '<div class="spinner"></div> â³ ì—…ë¡œë“œ ë° AI ë¶„ì„ ì¤‘... (ì˜¤ë˜ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)';
            mixerArea.style.display = 'none';
            tracksContainer.innerHTML = '';

            const formData = new FormData(uploadForm); // í¼ì˜ ëª¨ë“  í•„ë“œ (file, use_ai_eq)ë¥¼ ìë™ìœ¼ë¡œ í¬í•¨

            try {
                const res = await fetch(API_URL, { method: 'POST', body: formData });
                const data = await res.json();

                if (res.ok && data.status === 'success') {
                    statusDisplay.innerText = "âœ… ì¤€ë¹„ ì™„ë£Œ! AI ì¶”ì²œ EQê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.";
                    mixerArea.style.display = 'block';
                    initMixer(data);
                } else {
                    const errorDetail = data.detail || 'ì•Œ ìˆ˜ ì—†ëŠ” ì„œë²„ ì˜¤ë¥˜';
                    statusDisplay.innerHTML = `âŒ ì—ëŸ¬: ${errorDetail}`;
                    console.error("FastAPI Error:", data);
                }
            } catch (e) {
                console.error("í†µì‹  ì—ëŸ¬:", e);
                statusDisplay.innerHTML = `âŒ í†µì‹  ì—ëŸ¬: ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`;
            } finally {
                uploadBtn.disabled = false;
            }
        });

        // ====== 2. Web Audio API ì´ˆê¸°í™” ë° ì—°ê²° ======

        function initMixer(data) {
            tracksContainer.innerHTML = "";
            
            // Web Audio API ì‹œì‘
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            // Web Audio APIëŠ” íŠ¸ë™ë³„ë¡œ í•œ ë²ˆì”©ë§Œ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.
            tracks.length = 0;

            const stems = ['vocals', 'drums', 'bass', 'other'];
            
            stems.forEach(stem => {
                if (!data.urls[stem]) return;

                const eqVals = data.eq_info[stem] || { low: 0, mid: 0, high: 0 };
                
                // 1. HTML UI ìƒì„±
                const div = document.createElement('div');
                div.className = `track-row t-${stem}`;
                div.innerHTML = `
                    <div class="track-info">
                        <span class="track-name">${stem}</span>
                        <small>AI ì¶”ì²œ: L:${eqVals.low} / M:${eqVals.mid} / H:${eqVals.high}</small>
                    </div>
                    <div class="eq-controls">
                        ${createSliderHTML(stem, 'low', 'Low (100Hz)', eqVals.low)}
                        ${createSliderHTML(stem, 'mid', 'Mid (1kHz)', eqVals.mid)}
                        ${createSliderHTML(stem, 'high', 'High (10kHz)', eqVals.high)}
                    </div>
                    <!-- controls ì†ì„±ì´ í•„ìš”í•¨ -->
                    <audio id="audio-${stem}" src="${data.urls[stem]}" controls crossOrigin="anonymous"></audio>
                `;
                tracksContainer.appendChild(div);

                // 2. Web Audio API ì—°ê²°
                setupAudioNodes(stem, eqVals);
            });
        }

        function createSliderHTML(stem, band, label, val) {
            // valì„ 0.1 ë‹¨ìœ„ë¡œ ê³ ì •
            const displayVal = parseFloat(val).toFixed(1);
            return `
                <div class="slider-group">
                    <label>${label}</label>
                    <input type="range" id="sl-${stem}-${band}" min="-15" max="15" step="0.1" value="${displayVal}" 
                        oninput="updateEQ('${stem}', '${band}', this.value)">
                    <div class="val-display" id="val-${stem}-${band}">${displayVal}dB</div>
                </div>
            `;
        }

        function setupAudioNodes(stem, initialEq) {
            const audioEl = document.getElementById(`audio-${stem}`);
            
            // ë¯¸ë””ì–´ ì†ŒìŠ¤ ìƒì„±
            const source = audioCtx.createMediaElementSource(audioEl);

            // í•„í„° ìƒì„±: Low Shelf (100Hz), Peaking (1000Hz), High Shelf (10000Hz)
            const lowFilter = audioCtx.createBiquadFilter();
            lowFilter.type = "lowshelf";
            lowFilter.frequency.value = 100;
            lowFilter.gain.value = initialEq.low;

            const midFilter = audioCtx.createBiquadFilter();
            midFilter.type = "peaking";
            midFilter.frequency.value = 1000;
            midFilter.Q.value = 1.0; 
            midFilter.gain.value = initialEq.mid;

            const highFilter = audioCtx.createBiquadFilter();
            highFilter.type = "highshelf";
            highFilter.frequency.value = 10000;
            highFilter.gain.value = initialEq.high;

            // ì—°ê²°: ì†ŒìŠ¤ -> Low -> Mid -> High -> ìŠ¤í”¼ì»¤
            source.connect(lowFilter);
            lowFilter.connect(midFilter);
            midFilter.connect(highFilter);
            highFilter.connect(audioCtx.destination);

            // ì°¸ì¡° ì €ì¥ (ë‚˜ì¤‘ì— ì—…ë°ì´íŠ¸ìš©)
            tracks[stem] = { low: lowFilter, mid: midFilter, high: highFilter };
            
            // ì˜¤ë””ì˜¤ ì¬ìƒ ì‹œ AudioContextê°€ suspended ìƒíƒœë©´ ê¹¨ì›Œì¤Œ
            audioEl.onplay = () => { if (audioCtx.state === 'suspended') audioCtx.resume(); };
        }

        // ====== 3. ì»¨íŠ¸ë¡¤ í•¨ìˆ˜ (ê¸€ë¡œë²Œ) ======

        // ìŠ¬ë¼ì´ë” ì¡°ì‘ ì‹œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
        window.updateEQ = function(stem, band, value) {
            const floatVal = parseFloat(value);
            // í™”ë©´ ìˆ«ì ì—…ë°ì´íŠ¸
            document.getElementById(`val-${stem}-${band}`).innerText = floatVal.toFixed(1) + "dB";
            
            // ì‹¤ì œ ì˜¤ë””ì˜¤ í•„í„° ì—…ë°ì´íŠ¸
            if (tracks[stem]) {
                tracks[stem][band].gain.value = floatVal;
            }
        };

        window.playAll = function() {
            // ì¬ìƒ ì‹œ AudioContext resume ë³´ì¥
            if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume(); 
            document.querySelectorAll('audio').forEach(a => { a.currentTime = 0; a.play(); });
        };
        window.stopAll = function() {
            document.querySelectorAll('audio').forEach(a => { a.pause(); a.currentTime = 0; });
        };
    </script>
</body>
</html>