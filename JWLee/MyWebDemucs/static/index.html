<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ìŠ¤ë§ˆíŠ¸ ë¯¹ì„œ</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; padding: 20px; background-color: #121212; color: #e0e0e0; }
        .container { background: #1e1e1e; padding: 30px; border-radius: 15px; max-width: 800px; margin: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        h1 { color: #00d2ff; }
        
        .upload-section { border: 2px dashed #444; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; transition: 0.2s; }
        button:hover { background: #0056b3; }
        button:disabled { background: #444; cursor: not-allowed; }

        /* íŠ¸ë™ ë ˆì´ì•„ì›ƒ */
        .track-row { 
            background: #2c2c2c; margin: 15px 0; padding: 15px; border-radius: 10px; 
            display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between;
            border-left: 5px solid #555;
        }
        .track-info { flex: 1; text-align: left; min-width: 150px; }
        .track-name { font-size: 18px; font-weight: bold; display: block; margin-bottom: 5px; text-transform: uppercase;}
        .eq-controls { flex: 2; display: flex; gap: 15px; justify-content: center; min-width: 300px; }
        
        /* ìŠ¬ë¼ì´ë” ìŠ¤íƒ€ì¼ */
        .slider-group { text-align: center; }
        .slider-group label { display: block; font-size: 12px; color: #888; margin-bottom: 2px; }
        input[type=range] { width: 80px; accent-color: #00d2ff; cursor: pointer; }
        .val-display { font-size: 12px; font-weight: bold; color: #00d2ff; }

        audio { width: 100%; margin-top: 10px; height: 30px; }
        
        .master-controls { margin-top: 20px; padding-top: 20px; border-top: 1px solid #444; }
        .btn-green { background: #28a745; }
        .btn-red { background: #dc3545; }

        /* íŠ¸ë™ë³„ ìƒ‰ìƒ */
        .t-vocals { border-color: #ff6b6b; color: #ff6b6b; }
        .t-drums { border-color: #4ecdc4; color: #4ecdc4; }
        .t-bass { border-color: #ffe66d; color: #ffe66d; }
        .t-other { border-color: #1a535c; color: #1a535c; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ›ï¸ AI ìŠ¤ë§ˆíŠ¸ ë¯¹ì„œ</h1>
        <p>AIê°€ ì œì•ˆí•œ EQë¥¼ í™•ì¸í•˜ê³ , ìŠ¬ë¼ì´ë”ë¡œ ì§ì ‘ í†¤ì„ ì¡ì•„ë³´ì„¸ìš”.</p>

        <div class="upload-section">
            <input type="file" id="audioFile" accept=".mp3, .wav">
            <button onclick="startProcess()" id="uploadBtn">ì—…ë¡œë“œ ë° ë¶„ì„</button>
            <div id="status" style="margin-top: 10px; color: #ffcc00; font-weight: bold;"></div>
        </div>

        <div id="mixer-area" style="display: none;">
            <div class="master-controls">
                <button class="btn-green" onclick="playAll()">â–¶ ì „ì²´ ì¬ìƒ</button>
                <button class="btn-red" onclick="stopAll()">â¹ ì „ì²´ ì •ì§€</button>
            </div>
            <div id="tracks-container"></div>
        </div>
    </div>

    <script>
        // Web Audio API ì»¨í…ìŠ¤íŠ¸ (ë¸Œë¼ìš°ì €ì˜ ì˜¤ë””ì˜¤ ì—”ì§„)
        let audioCtx;
        const tracks = {}; // íŠ¸ë™ë³„ ë…¸ë“œ ì €ì¥ì†Œ { vocals: { source, low, mid, high, gain } }

        async function startProcess() {
            const file = document.getElementById('audioFile').files[0];
            if (!file) { alert("íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”!"); return; }
            
            const btn = document.getElementById('uploadBtn');
            const status = document.getElementById('status');
            
            btn.disabled = true;
            status.innerText = "â³ ì—…ë¡œë“œ ë° AI ë¶„ì„ ì¤‘... (ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”)";

            const formData = new FormData();
            formData.append("file", file);

            try {
                const res = await fetch('/upload', { method: 'POST', body: formData });
                const data = await res.json();

                if (res.ok) {
                    status.innerText = "âœ… ì¤€ë¹„ ì™„ë£Œ! ìŠ¬ë¼ì´ë”ë¥¼ ì›€ì§ì—¬ë³´ì„¸ìš”.";
                    document.getElementById('mixer-area').style.display = 'block';
                    initMixer(data);
                } else {
                    status.innerText = "âŒ ì—ëŸ¬: " + JSON.stringify(data);
                }
            } catch (e) {
                console.error(e);
                status.innerText = "âŒ í†µì‹  ì—ëŸ¬";
            } finally {
                btn.disabled = false;
            }
        }

        function initMixer(data) {
            const container = document.getElementById('tracks-container');
            container.innerHTML = ""; // ì´ˆê¸°í™”
            
            // Web Audio API ì‹œì‘ (ì‚¬ìš©ì ì œìŠ¤ì²˜ í•„ìš”í•˜ë¯€ë¡œ ì¬ìƒ ì‹œ resume ë  ìˆ˜ ìˆìŒ)
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();

            const stems = ['vocals', 'drums', 'bass', 'other'];
            
            stems.forEach(stem => {
                if (!data.urls[stem]) return;

                // 1. HTML UI ìƒì„±
                const eqVals = data.eq_info[stem] || { low: 0, mid: 0, high: 0 };
                const div = document.createElement('div');
                div.className = `track-row t-${stem}`;
                div.innerHTML = `
                    <div class="track-info">
                        <span class="track-name">${stem}</span>
                        <small>AI ì¶”ì²œ: L:${eqVals.low} / M:${eqVals.mid} / H:${eqVals.high}</small>
                    </div>
                    <div class="eq-controls">
                        ${createSliderHTML(stem, 'low', 'Low (100Hz)', eqVals.low)}
                        ${createSliderHTML(stem, 'mid', 'Mid (1kHz)', eqVals.mid)}
                        ${createSliderHTML(stem, 'high', 'High (10kHz)', eqVals.high)}
                    </div>
                    <audio id="audio-${stem}" src="${data.urls[stem]}" controls crossOrigin="anonymous"></audio>
                `;
                container.appendChild(div);

                // 2. Web Audio API ì—°ê²°
                setupAudioNodes(stem, eqVals);
            });
        }

        function createSliderHTML(stem, band, label, val) {
            return `
                <div class="slider-group">
                    <label>${label}</label>
                    <input type="range" id="sl-${stem}-${band}" min="-15" max="15" step="0.1" value="${val}" 
                        oninput="updateEQ('${stem}', '${band}', this.value)">
                    <div class="val-display" id="val-${stem}-${band}">${val}dB</div>
                </div>
            `;
        }

        function setupAudioNodes(stem, initialEq) {
            const audioEl = document.getElementById(`audio-${stem}`);
            
            // ë¯¸ë””ì–´ ì†ŒìŠ¤ ìƒì„±
            const source = audioCtx.createMediaElementSource(audioEl);

            // í•„í„° ìƒì„±
            const lowFilter = audioCtx.createBiquadFilter();
            lowFilter.type = "lowshelf";
            lowFilter.frequency.value = 100;
            lowFilter.gain.value = initialEq.low;

            const midFilter = audioCtx.createBiquadFilter();
            midFilter.type = "peaking";
            midFilter.frequency.value = 1000;
            midFilter.Q.value = 1.0;
            midFilter.gain.value = initialEq.mid;

            const highFilter = audioCtx.createBiquadFilter();
            highFilter.type = "highshelf";
            highFilter.frequency.value = 10000;
            highFilter.gain.value = initialEq.high;

            // ì—°ê²°: ì†ŒìŠ¤ -> Low -> Mid -> High -> ìŠ¤í”¼ì»¤
            source.connect(lowFilter);
            lowFilter.connect(midFilter);
            midFilter.connect(highFilter);
            highFilter.connect(audioCtx.destination);

            // ì°¸ì¡° ì €ì¥ (ë‚˜ì¤‘ì— ì—…ë°ì´íŠ¸ìš©)
            tracks[stem] = { low: lowFilter, mid: midFilter, high: highFilter };
            
            // ì˜¤ë””ì˜¤ ì¬ìƒ ì‹œ AudioContextê°€ suspended ìƒíƒœë©´ ê¹¨ì›Œì¤Œ
            audioEl.onplay = () => { if (audioCtx.state === 'suspended') audioCtx.resume(); };
        }

        // ìŠ¬ë¼ì´ë” ì¡°ì‘ ì‹œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
        window.updateEQ = function(stem, band, value) {
            // í™”ë©´ ìˆ«ì ì—…ë°ì´íŠ¸
            document.getElementById(`val-${stem}-${band}`).innerText = value + "dB";
            
            // ì‹¤ì œ ì˜¤ë””ì˜¤ í•„í„° ì—…ë°ì´íŠ¸
            if (tracks[stem]) {
                tracks[stem][band].gain.value = parseFloat(value);
            }
        };

        window.playAll = function() {
            document.querySelectorAll('audio').forEach(a => { a.currentTime = 0; a.play(); });
        };
        window.stopAll = function() {
            document.querySelectorAll('audio').forEach(a => { a.pause(); a.currentTime = 0; });
        };
    </script>
</body>
</html>